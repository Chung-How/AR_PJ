<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<!-- three.js library -->
<script src='../examples/vendor/three.js/build/three.min.js'></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="../examples/vendor/three.js/examples/js/libs/stats.min.js"></script>
<!-- ar.js -->
<script src="../build/ar.js"></script>
<script>
    THREEx.ArToolkitContext.baseURL = '../'
</script>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>
    <div style='font-size:2em; color:cyan; position: absolute; top: 10px; width:100%; text-align: center; z-index: 1;'>
        <a href="https://github.com/jeromeetienne/AR.js/" target="_blank">AR.js</a>
        <br>
        Independent Markers
        <p style='color:yellow' id='printDis'></p>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://threejs.org/build/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.js"></script>

    <script>
        // global variables
        var camera, scene, renderer;
        var markerKanji, markerHiro;
        var arToolKitSource, arToolKitContext;

        var cannon;
        var pos, vel, force;

        var _iOSDevice;

        init();
        animate();

        function init() {
            // https://stackoverflow.com/questions/9038625/detect-if-device-is-ios?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
            let _iOSDevice = !!navigator.platform.match(/iPhone|iPod|iPad/);

            console.log('iOS: ' + _iOSDevice)

            // init renderer
            renderer = new THREE.WebGLRenderer({
                // antialias	: true,
                alpha: true
            });
            renderer.setClearColor(new THREE.Color('lightgrey'), 0)
            // renderer.setPixelRatio( 1/2 );
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.position = 'absolute'
            renderer.domElement.style.top = '0px'
            renderer.domElement.style.left = '0px'
            document.body.appendChild(renderer.domElement);

            // init scene and camera
            scene = new THREE.Scene();

            //////////////////////////////////////////////////////////////////////////////////
            //		Initialize a basic camera
            //////////////////////////////////////////////////////////////////////////////////

            // Create a camera
            camera = new THREE.Camera();
            scene.add(camera);

            ////////////////////////////////////////////////////////////////////////////////
            //          handle arToolkitSource
            ////////////////////////////////////////////////////////////////////////////////

            arToolkitSource = new THREEx.ArToolkitSource({
                // to read from the webcam 
                sourceType: 'webcam',

                // to read from an image
                // sourceType : 'image',
                // sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/images/img.jpg',		

                // to read from a video
                // sourceType : 'video',
                // sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/videos/headtracking.mp4',		
            })

            arToolkitSource.init(function onReady() {
                onResize()
            })

            // handle resize
            window.addEventListener('resize', function() {
                onResize()
            })

            function onResize() {
                arToolkitSource.onResize()
                arToolkitSource.copySizeTo(renderer.domElement)
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)
                }
            }
            ////////////////////////////////////////////////////////////////////////////////
            //          initialize arToolkitContext
            ////////////////////////////////////////////////////////////////////////////////

            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: THREEx.ArToolkitContext.baseURL + '../data/data/camera_para.dat',
                detectionMode: 'mono',
                maxDetectionRate: 30,
                canvasWidth: 80 * 3,
                canvasHeight: 60 * 3,
            })
            // initialize it
            arToolkitContext.init(function onCompleted() {
                // copy projection matrix to camera
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            })

            markerHiro = addMarkerHiro();
            scene.add(markerHiro);
            markerKanji = addMarkerKanji();
            scene.add(markerKanji);

        }


        function addMarkerHiro() {
            let markerRootHiro = new THREE.Group()

            var artoolkitMarker = new THREEx.ArMarkerControls(arToolkitContext, markerRootHiro, {
                type: 'pattern',
                patternUrl: THREEx.ArToolkitContext.baseURL + '../data/data/patt.hiro'
            })

            // add a box for Hiro
            cannon = makeCannon();

            markerRootHiro.add(cannon);
            var ball = new THREE.Mesh(new THREE.SphereGeometry(0.05, 8, 8), new THREE.MeshBasicMaterial({
                color: 'yellow',
                wireframe: true
            }));
            markerRootHiro.add(ball);

            return markerRootHiro;
        }

        function addMarkerKanji() {
            let markerRootKanji = new THREE.Group();
            var artoolkitMarker = new THREEx.ArMarkerControls(arToolkitContext, markerRootKanji, {
                type: 'pattern',
                patternUrl: THREEx.ArToolkitContext.baseURL + '../data/data/patt.kanji'
            })
            // add a sphere for Hiro
            var geometry = new THREE.SphereGeometry(0.1, 20, 20);
            var material = new THREE.MeshNormalMaterial();
            box2 = new THREE.Mesh(geometry, material);
            box2.position.y = 0.1;

            markerRootKanji.add(box2);

            return markerRootKanji;
        }

        function makeCannon() {
            let cannon = new THREE.Group();
            let body = new THREE.Mesh(new THREE.SphereGeometry(
                0.5, 20, 20, Math.PI + Math.PI * 0.1, Math.PI * 1.8, 0, Math.PI / 2), new THREE.MeshNormalMaterial());
            let barrelPart = new THREE.Group();
            let barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 5, 18), new THREE.MeshNormalMaterial());
            barrelPart.add(barrel);
            barrel.position.y = 10;

            cannon.add(body, barrelPart);
            return cannon;
        }

        function computeInitPosVel() {
            let barrel = cannon.children[1];
            const SPEED = 25;

            vel = barrel.localToWorld(new THREE.Vector3(0, 20, 0)).sub(
                barrel.localToWorld(new THREE.Vector3(0, 0, 0))).setLength(SPEED);
            pos = barrel.localToWorld(new THREE.Vector3(0, 22, 0));
            force = new THREE.Vector3(0, -10, 0);
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);

            if (arToolkitSource.ready === false) return
            arToolkitContext.update(arToolkitSource.domElement)

            ///////////////////////////////////////////////////////////
            if (pos === undefined) {
                computeInitPosVel();
                return;
            }
            if (pos.y < 0)
                return;

            let dt = clock.getDelta();

            // Euler's method
            vel.add(force.clone().multiplyScalar(dt));
            pos.add(vel.clone().multiplyScalar(dt));
            ball.position.copy(pos);
        }
    </script>
</body>